<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>rtorf Obspack GLOBALView+ • rtorf</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="rtorf Obspack GLOBALView+">
<meta name="description" content="Reads, process, and plots the CH4 ObsPack GLOBALView+ data from NOAA and perform different filters and analyses.">
<meta property="og:description" content="Reads, process, and plots the CH4 ObsPack GLOBALView+ data from NOAA and perform different filters and analyses.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">rtorf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-gml/rtorf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="r-tools-for-obspack-footprints-and-receptors-rtorf">R Tools for Obspack, Footprints and Receptors (rtorf)<a class="anchor" aria-label="anchor" href="#r-tools-for-obspack-footprints-and-receptors-rtorf"></a>
</h1></div>
<p><img src="https://img.shields.io/github/commit-activity/y/noaa-gml/rtorf" alt="GitHub commit activity"><a href="https://github.com/noaa-gml/rtorf/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/noaa-gml/rtorf/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a> <img src="https://img.shields.io/github/stars/noaa-gml/rtorf" alt="GitHub Repo stars"></p>
<p><a href="https://gml.noaa.gov/ccgg/obspack/" class="external-link">NOAA Obspack</a> is a collection of green house gases observations</p>
<p><code>rtorf</code> only depends on <code>data.table</code> and <code>ncdf4</code>, which is basically parallel C, so it can be installed in any machine.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"noaa-gml/rtorf"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-gml/rtorf" class="external-link">rtorf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="obspack-summary">ObsPack summary<a class="anchor" aria-label="anchor" href="#obspack-summary"></a>
</h2>
<p>The first step consists in constructing a summary for the ObsPack. This is required to read the data, but also, identify <code>agl</code>, which is present in some of the file names. This function returns a <code>data.frame</code>. Optionally, the user can indicate a path to store the <code>data.frame</code>. <code>obs_summary</code> also prints a summary of the data. The second argument is the categories, and by default includes the categories shown below, to account for all the files. Then the summary <code>data.frame</code> contains the columns <code>id</code> as the full path to each file, <code>name</code> which is the name or relative path of the file, <code>n</code> just an id, <code>sector</code> such as tower, and the column <code>agl</code> which indicates the <code>agl</code> indicated in the name of the file if available. To read the documentation of this function, the user must run <code><a href="reference/obs_summary.html">?obs_summary</a></code>.</p>
<blockquote>
<p>We first define the categories</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aircraft-pfp"</span>,</span>
<span>         <span class="st">"aircraft-insitu"</span>,</span>
<span>         <span class="st">"aircraft-flask"</span>,</span>
<span>         <span class="st">"surface-insitu"</span>,</span>
<span>         <span class="st">"surface-flask"</span>, </span>
<span>         <span class="st">"surface-pfp"</span>,   </span>
<span>         <span class="st">"tower-insitu"</span>,  </span>
<span>         <span class="st">"aircore"</span>,       </span>
<span>         <span class="st">"shipboard-insitu"</span>,</span>
<span>         <span class="st">"shipboard-flask"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="st">"Z:/torf/obspack_ch4_1_GLOBALVIEWplus_v5.1_2023-03-08/data/nc/"</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_summary.html">obs_summary</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span>, categories <span class="op">=</span> <span class="va">cate</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="do">## Number of files of index: 429</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="do">##               sector     N</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="do">##               &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="do">##  1:     aircraft-pfp    40</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="do">##  2:  aircraft-insitu    15</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="do">##  3:    surface-flask   106</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="do">##  4:   surface-insitu   174</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="do">##  5:   aircraft-flask     4</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="do">##  6:          aircore     1</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="do">##  7:      surface-pfp    33</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="do">##  8:     tower-insitu    51</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="do">##  9:  shipboard-flask     4</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="do">## 10: shipboard-insitu     1</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="do">## 11:    Total sectors   429</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="do">## Detected 190 files with agl</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="do">## Detected 239 files without agl</span></span></code></pre></div>
<p>There are 429 files in the ObsPack directory. The printed information also shows the total at the bottom, as the sum of the individual file by sector. This is to ensure that the sum of files is equal to the total number of files found, shown at the top. furthermore, the printed information also shows that there are 109 files with the <code>agl</code> explicitly mentioned in the name of the file.</p>
<div class="section level3">
<h3 id="read-data">Read data<a class="anchor" aria-label="anchor" href="#read-data"></a>
</h3>
<p>Once the summary is built, the function <code>obs_read</code> will read the files available in the index file previously generated. Here we selected the category “tower-insitu”. The argument verbose prints which files are being read each time, by default. At the end, this function prints the total number of observations by type of altitude (agl or asl).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_read_nc.html">obs_read_nc</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span>,</span>
<span>                  categories <span class="op">=</span> <span class="st">"tower-insitu"</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>intake_height or altitude_final</p>
</blockquote>
<p>The identification of the altitude and type is critical. The approach used here consists of:</p>
<ol style="list-style-type: decimal">
<li>Use intake_height</li>
<li>Identify <code>agl</code> from the name of the tile.</li>
<li>If <code>agl</code> is not present, <code>agl = altitude - site_elevation</code>.</li>
<li>If there are some NA in elevation, will result some NA in <code>agl</code>
</li>
<li>A new column is added named <code>altitude_final</code> to store <code>agl</code> or <code>asl</code>
</li>
<li>Another column named <code>type_altitude</code> is added to identify <code>agl</code> as 0, or <code>asl</code> as 1.</li>
</ol>
<p>To maintain a coherent approach among text and NetCDF files, we will add a column altitude_final and type_altitude. This is done in <code>obs_read_nc</code> or <code>obs_read</code>.</p>
<p>Sometimes we need more information about the site. For instance, what do the observations start and end. Then, we added the function <code>obs_table</code>, which calculates statistics summary of “time” and other numeric variables by file name, sector, site, altitude and mode.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dft</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_table.html">obs_table</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p>Now we can visualize the average of observations by site.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="va">sdft</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">dft</span><span class="op">[</span><span class="va">stat</span> <span class="op">==</span> <span class="st">"mean"</span><span class="op">]</span>, </span>
<span>                 coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, </span>
<span>                 crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">sdft</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">sdft</span><span class="op">$</span><span class="va">value</span><span class="op">*</span><span class="fl">1e09</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sdft</span><span class="op">[</span><span class="st">"value"</span><span class="op">]</span>, </span>
<span>     reset <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>     axes <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>     graticule <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>     pch <span class="op">=</span> <span class="fl">16</span>, </span>
<span>     cex <span class="op">=</span> <span class="fl">1.5</span>, </span>
<span>     pal <span class="op">=</span> <span class="fu">cptcity</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cptcity/man/lucky.html" class="external-link">lucky</a></span><span class="op">(</span>colorRampPalette <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="co">#random</span></span>
<span>     main <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="do">## Colour gradient: nd_turanj_Secondary_02a, number: 5932</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">maps</span><span class="fu">::</span><span class="fu">map</span><span class="op">(</span>add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/sf-1.png"><!-- --></p>
<p>Let us randomly select a couples of sites from the database.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">site_name</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">site_name</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">usites</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="do">## [1] "Noyabrsk"           "Danville, Virginia"</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">dft</span><span class="op">[</span><span class="va">site_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">usites</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="12%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="6%">
<col width="6%">
<col width="7%">
<col width="8%">
<col width="6%">
<col width="6%">
<col width="4%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">site_name</th>
<th align="right">site_latitude</th>
<th align="right">site_longitude</th>
<th align="left">site_country</th>
<th align="left">site_code</th>
<th align="right">value</th>
<th align="right">time</th>
<th align="right">time_decimal</th>
<th align="right">latitude</th>
<th align="right">longitude</th>
<th align="left">stat</th>
<th align="left">timeUTC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">1.847e-06</td>
<td align="right">1468449000</td>
<td align="right">2017</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">min</td>
<td align="left">2016-07-13 22:30:00</td>
</tr>
<tr class="even">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">1.945e-06</td>
<td align="right">1483676100</td>
<td align="right">2017</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">q1</td>
<td align="left">2017-01-06 04:15:00</td>
</tr>
<tr class="odd">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">1.966e-06</td>
<td align="right">1494000000</td>
<td align="right">2017</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">median</td>
<td align="left">2017-05-05 16:00:00</td>
</tr>
<tr class="even">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">1.970e-06</td>
<td align="right">1493261865</td>
<td align="right">2017</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">mean</td>
<td align="left">2017-04-27 02:57:45</td>
</tr>
<tr class="odd">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">1.994e-06</td>
<td align="right">1504986300</td>
<td align="right">2018</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">q3</td>
<td align="left">2017-09-09 19:45:00</td>
</tr>
<tr class="even">
<td align="left">Danville, Virginia</td>
<td align="right">36.7058</td>
<td align="right">-79.4369</td>
<td align="left">United States</td>
<td align="left">DVV</td>
<td align="right">2.356e-06</td>
<td align="right">1514763000</td>
<td align="right">2018</td>
<td align="right">36.71</td>
<td align="right">-79.44</td>
<td align="left">max</td>
<td align="left">2017-12-31 23:30:00</td>
</tr>
<tr class="odd">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">1.848e-06</td>
<td align="right">1130434200</td>
<td align="right">2006</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">min</td>
<td align="left">2005-10-27 17:30:00</td>
</tr>
<tr class="even">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">1.985e-06</td>
<td align="right">1326479400</td>
<td align="right">2012</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">q1</td>
<td align="left">2012-01-13 18:30:00</td>
</tr>
<tr class="odd">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">2.038e-06</td>
<td align="right">1418131800</td>
<td align="right">2015</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">median</td>
<td align="left">2014-12-09 13:30:00</td>
</tr>
<tr class="even">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">2.064e-06</td>
<td align="right">1405484932</td>
<td align="right">2015</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">mean</td>
<td align="left">2014-07-16 04:28:52</td>
</tr>
<tr class="odd">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">2.108e-06</td>
<td align="right">1500283800</td>
<td align="right">2018</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">q3</td>
<td align="left">2017-07-17 09:30:00</td>
</tr>
<tr class="even">
<td align="left">Noyabrsk</td>
<td align="right">63.4292</td>
<td align="right">75.7800</td>
<td align="left">Russia</td>
<td align="left">NOY</td>
<td align="right">3.755e-06</td>
<td align="right">1572496200</td>
<td align="right">2020</td>
<td align="right">63.43</td>
<td align="right">75.78</td>
<td align="left">max</td>
<td align="left">2019-10-31 04:30:00</td>
</tr>
</tbody>
</table>
<p>We added a function to plot the data read from ObsPack. The y-axis is the field <code>value</code> and the x-axis is by default <code>time</code>. The data illustrated sorted by color is the field <code>site_code</code>, with the default number of 3 sites. The argument <code>pal</code> is to define the color palette, used by the internally imported function <code><a href="https://rdrr.io/pkg/cptcity/man/cpt.html" class="external-link">cptcity::cpt</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/obs_plot.html">obs_plot</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">df</span><span class="op">[</span><span class="va">site_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">usites</span><span class="op">]</span>, </span>
<span>         time <span class="op">=</span> <span class="st">"time"</span>, </span>
<span>         yfactor <span class="op">=</span> <span class="fl">1e9</span>, </span>
<span>         cex <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>         verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<figure><img src="README_files/figure-gfm/unnamed-chunk-8-1.png" alt="First two sites in ObsPack"><figcaption aria-hidden="true">
First two sites in ObsPack
</figcaption></figure><p>Here we can see 2.61 million observations for <code>tower-insitu</code>. These observations are made between 2004 and 2021.</p>
</div>
<div class="section level3">
<h3 id="filtering">Filtering<a class="anchor" aria-label="anchor" href="#filtering"></a>
</h3>
<p>ObsPack includes global observations and sometimes we need to extract data for a specific region and periods of time. In this part we include spatial and temporal parameters to filter data. The year of interest is 2020, but we also included December of 2019 and January of 2021. At this stage, we can apply the spatial filter by using the coordinates.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">north</span> <span class="op">&lt;-</span> <span class="fl">80</span></span>
<span><span class="va">south</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">west</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">170</span></span>
<span><span class="va">east</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">50</span></span>
<span><span class="va">max_altitude</span> <span class="op">&lt;-</span> <span class="fl">8000</span></span>
<span><span class="va">evening</span> <span class="op">&lt;-</span> <span class="fl">14</span></span>
<span></span>
<span><span class="va">yy</span> <span class="op">&lt;-</span> <span class="fl">2020</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">12</span><span class="op">]</span>,</span>
<span>            <span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span><span class="op">]</span>,</span>
<span>            <span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">altitude_final</span> <span class="op">&lt;</span> <span class="va">max_altitude</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&lt;</span> <span class="va">north</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&gt;</span> <span class="va">south</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&lt;</span> <span class="va">east</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&gt;</span> <span class="va">west</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"altitude_final"</span>, <span class="st">"site_elevation"</span>, <span class="st">"elevation"</span>,</span>
<span>              <span class="st">"dataset_selection_tag"</span>,</span>
<span>              <span class="st">"site_name"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="do">##     altitude_final site_elevation elevation dataset_selection_tag</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="do">##              &lt;num&gt;          &lt;num&gt;     &lt;num&gt;                &lt;char&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="do">##  1:           17.1         611.43    611.43       allvalid-17magl</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="do">##  2:           31.7         611.43    611.43       allvalid-32magl</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="do">##  3:            4.9         611.43    611.43        allvalid-5magl</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="do">##  4:          122.0         472.00    472.00      allvalid-122magl</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="do">##  5:           30.0         472.00    472.00       allvalid-30magl</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="do">##  6:          396.0         472.00    472.00      allvalid-396magl</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="do">##  7:          304.8         115.20    115.20      allvalid-305magl</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="do">##  8:           31.0         115.20    115.20       allvalid-31magl</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="do">##  9:           61.0         115.20    115.20       allvalid-61magl</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="do">## 10:           30.0           2.00      2.00       allvalid-30magl</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="do">## 11:          484.0           2.00      2.00      allvalid-483magl</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="do">## 12:           89.1           2.00      2.00       allvalid-91magl</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="do">##                                                        site_name</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="do">##                                                           &lt;char&gt;</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="do">##  1: Carbon in Arctic Reservoirs Vulnerability Experiment (CARVE)</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="do">##  2: Carbon in Arctic Reservoirs Vulnerability Experiment (CARVE)</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="do">##  3: Carbon in Arctic Reservoirs Vulnerability Experiment (CARVE)</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="do">##  4:                                        Park Falls, Wisconsin</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="do">##  5:                                        Park Falls, Wisconsin</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="do">##  6:                                        Park Falls, Wisconsin</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="do">##  7:                                 Beech Island, South Carolina</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="do">##  8:                                 Beech Island, South Carolina</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="do">##  9:                                 Beech Island, South Carolina</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="do">## 10:                                     Walnut Grove, California</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="do">## 11:                                     Walnut Grove, California</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="do">## 12:                                     Walnut Grove, California</span></span></code></pre></div>
<p>After filtering by space and time, we have 1.12883^{5} million observations. Towers can have observations at different heights. Here we need to select one site with the observations registered at the highest height. The column with the height is named <code>altitude_final</code> and the max altitude was named <code>max_altitude</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfa</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">altitude_final</span><span class="op">)</span>,</span>
<span>          by <span class="op">=</span> <span class="va">site_code</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dfa</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"max_altitude"</span></span>
<span><span class="va">dfa</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="do">##    site_code max_altitude</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="do">##       &lt;char&gt;        &lt;num&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="do">## 1:       CRV         31.7</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="do">## 2:       LEF        396.0</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="do">## 3:       SCT        304.8</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="do">## 4:       WGC        484.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="key-time">Key Time<a class="anchor" aria-label="anchor" href="#key-time"></a>
</h3>
<p>Here we need to start time columns. The function <code>obs_addtime</code> adds time columns <code>timeUTC</code>, <code>timeUTC_start</code> which shows the start time of each observation and <code>timeUTC_end</code> which shows the end time for each observation.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addtime.html">obs_addtime</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="do">## Adding timeUTC</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="do">## Adding timeUTC_start</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="do">## Adding timeUTC_end</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="do">## Found time_interval</span></span></code></pre></div>
<p>Then we need a <em>key_time</em> to aggregate data. This can be done using UTC, solar, or local time. The normal approach is using afternoon solar or local time.</p>
<div class="section level4">
<h4 id="hierarchy-of-solar-or-local-time">Hierarchy of solar or local time<a class="anchor" aria-label="anchor" href="#hierarchy-of-solar-or-local-time"></a>
</h4>
<ol style="list-style-type: decimal">
<li>Solar time</li>
<li>Local time with columns <code>site_utc2lst</code>
</li>
<li>Local time longitude</li>
</ol>
<blockquote>
<p>solar time (default)</p>
</blockquote>
<p>Here we select the hours of interest and then aggregate data by year, month and day of solar time. In this way, we will have one information per day. however this approach is not appropriate for aircraft which are aggregated every 10 or 20 seconds. Hence we need to aggregate data by one time column. Also, this helps to generate the receptor info files including hour, minute and second. Hence, <em>we need to add solar or local time column</em>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span><span class="op">$</span><span class="va">solar_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addstime.html">obs_addstime</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>local time with column <code>site_utc2lst</code></p>
</blockquote>
<p>Then we need to identify the local time with the function <code>add_ltime</code>. This is important because to identifying observations in the evening in local time. <code>add_ltime</code> uses two methods, first identify the time difference with utc by identifying the metadata column “site_utc2lst”. If solar time is not available #now we need to cut solar time for the frequency needed. As we will work with</p>
<blockquote>
<p>local time longitude</p>
</blockquote>
<p>If this information is not available, with the aircrafts for instance, the local time is calculated with an approximation based on longitude:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>t</mi><mo>=</mo><mi>U</mi><mi>T</mi><mi>C</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>n</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>/</mi><mn>15</mn><mo>*</mo><mn>60</mn><mo>*</mo><mn>60</mn></mrow><annotation encoding="application/x-tex">
lt = UTC + longitude/15 * 60 * 60
</annotation></semantics></math> Where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">lt</annotation></semantics></math> is the local time, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>T</mi><mi>C</mi></mrow><annotation encoding="application/x-tex">UTC</annotation></semantics></math> the time, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mi>g</mi><mi>i</mi><mi>t</mi><mi>u</mi><mi>d</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">longitude</annotation></semantics></math> the coordinate. Then, the time is cut every two hours. Now, we identify the local time to select evening hours.</p>
</div>
<div class="section level4">
<h4 id="cut-time">Cut time<a class="anchor" aria-label="anchor" href="#cut-time"></a>
</h4>
<p>Now we have they key column time, we can cut it accordingly.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span><span class="op">$</span><span class="va">solar_time_cut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df2</span><span class="op">$</span><span class="va">solar_time</span>,</span>
<span>                          breaks <span class="op">=</span> <span class="st">"1 hour"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>How we can check the solar time and the cut solar time. Please note that solar_time_cut, the column that it will be used to aggregate data</p>
<p>How we filter for the required solar time, in this case 14.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df3</span> <span class="op">&lt;-</span> <span class="va">df2</span><span class="op">[</span><span class="va">hour_st</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">evening</span><span class="op">]</span></span>
<span><span class="va">df3</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"solar_time"</span>, <span class="st">"solar_time_cut"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="do">##                solar_time      solar_time_cut</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="do">##                    &lt;POSc&gt;              &lt;char&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="do">##    1: 2019-12-02 14:49:12 2019-12-02 14:00:00</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="do">##    2: 2019-12-03 14:48:48 2019-12-03 14:00:00</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="do">##    3: 2019-12-04 14:48:24 2019-12-04 14:00:00</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="do">##    4: 2019-12-05 14:48:00 2019-12-05 14:00:00</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="do">##    5: 2019-12-06 14:47:35 2019-12-06 14:00:00</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="do">##   ---                                        </span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="do">## 4312: 2021-01-27 14:11:38 2021-01-27 14:00:00</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="do">## 4313: 2021-01-28 14:11:26 2021-01-28 14:00:00</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="do">## 4314: 2021-01-29 14:11:14 2021-01-29 14:00:00</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a><span class="do">## 4315: 2021-01-30 14:11:03 2021-01-30 14:00:00</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a><span class="do">## 4316: 2021-01-31 14:10:52 2021-01-31 14:00:00</span></span></code></pre></div>
<p>Now there are 4316 observations and before filtering 112883. At this point we can calculate the averages of several columns by the cut time. The function <code>obs_agg</code> does this aggregation as shown in the following lines of code. The argument <code>gby</code> establish the function used to aggregate <code>cols</code>. I need to aggregate the data by date (year, month, date), because it is already filtered by the hours of interest. Then, I would have 1 observation per day.</p>
<p>As standard, let us define <code>key_time</code> as <code>solar_time</code>. The <code>obs_agg</code> function will aggregate the desired data by that column.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df3</span><span class="op">$</span><span class="va">key_time</span> <span class="op">&lt;-</span> <span class="va">df3</span><span class="op">$</span><span class="va">solar_time_cut</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df4</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_agg.html">obs_agg</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">df3</span>,</span>
<span>               gby <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>               cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"value"</span>,</span>
<span>                        <span class="st">"latitude"</span>,</span>
<span>                        <span class="st">"longitude"</span>,</span>
<span>                        <span class="st">"site_utc2lst"</span><span class="op">)</span>,</span>
<span>               verbose <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               byalt <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="do">## Selecting by alt</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="do">## Adding time</span></span></code></pre></div>
<p>Now there are 4316 observations, 108567 less observations. Here we add the column <code>max_altitude</code> to identify the max altitude by site.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df4</span><span class="op">[</span>,</span>
<span>    <span class="va">max_altitude</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">altitude_final</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">site_code</span><span class="op">]</span></span>
<span><span class="va">df4</span><span class="op">[</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_code"</span>,</span>
<span>      <span class="st">"altitude_final"</span>,</span>
<span>      <span class="st">"max_altitude"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="do">##     site_code altitude_final max_altitude</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="do">##        &lt;char&gt;          &lt;num&gt;        &lt;num&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="do">##  1:       CRV           17.1         31.7</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="do">##  2:       CRV           31.7         31.7</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="do">##  3:       CRV            4.9         31.7</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="do">##  4:       LEF          122.0        396.0</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="do">##  5:       LEF          396.0        396.0</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="do">##  6:       LEF           30.0        396.0</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="do">##  7:       SCT          304.8        304.8</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="do">##  8:       SCT           31.0        304.8</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="do">##  9:       SCT           61.0        304.8</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="do">## 10:       WGC           30.0        484.0</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a><span class="do">## 11:       WGC          484.0        484.0</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a><span class="do">## 12:       WGC           89.1        484.0</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="saving-master-as-text-and-csvy">Saving master as text and csvy<a class="anchor" aria-label="anchor" href="#saving-master-as-text-and-csvy"></a>
</h3>
<p>Now that we have all the required information, we can save the files. Here, we name the data.frame as master, because it contains all the information. This is important because some fields can be used in the future, and for traceability. For convenience, time variables are transformed into character before writing into the disk. The separation is space ” “.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">master</span> <span class="op">&lt;-</span> <span class="va">df3</span></span>
<span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span><span class="va">master</span>, </span>
<span>       file <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/tower_insitu_2020.txt"</span><span class="op">)</span>,</span>
<span>       sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span></code></pre></div>
<p>The format Comma Separated Value with YAML (CSVY)[^3] consists in a typical CSV with a YAML header. The function<code>obs_write_csvy</code> includes the argument <code>notes</code> which allows adding custom notes at the header of the file. Below the notes, <code>obs_write_csvy</code> adds the output of the R function <code>str</code>, which provides a vertical summary of the data, known as structure.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csvy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/tower_insitu_2020.csvy"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/obs_write_csvy.html">obs_write_csvy</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">master</span>,</span>
<span>               notes <span class="op">=</span> <span class="st">"tower 2020"</span>,</span>
<span>               out <span class="op">=</span> <span class="va">csvy</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To check the YAML header we read the first 38 lines of the files that were generated. Here we can see the column names, type of data and first observations. The YAML header is delimited by the characters “—”.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">csvy</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">34</span><span class="op">]</span> <span class="co"># and more</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="saving-receptors">Saving receptors<a class="anchor" aria-label="anchor" href="#saving-receptors"></a>
</h3>
<p>We need to filter some columns from the master files in a new object called receptors. This is needed because internally we run HYSPLIT [@hy] using the information from the receptors. In the case of a tower, we need to select observations with the highest altitude. The specific columns are selected as shown on the following code. We are selecting the ending times, because later HYSPLIT is run backwards based on the time of measurement, between ending and starting times. The columns about time are formatted to have two characters. For instance, the month 1, is formatted as “01”. We also need to filter for <code>type_altitude</code> equal 0, representing <code>agl</code>observations , or equal to 1, <code>asl</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">receptor</span> <span class="op">&lt;-</span> <span class="va">master</span><span class="op">[</span><span class="va">altitude_final</span> <span class="op">==</span> <span class="va">max_altitude</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_code"</span>,</span>
<span>                     <span class="st">"year"</span>,</span>
<span>                     <span class="st">"month"</span>,</span>
<span>                     <span class="st">"day"</span>,</span>
<span>                     <span class="st">"hour"</span>,</span>
<span>                     <span class="st">"minute"</span>,</span>
<span>                     <span class="st">"second"</span>,</span>
<span>                     <span class="st">"latitude"</span>,</span>
<span>                     <span class="st">"longitude"</span>,</span>
<span>                     <span class="st">"altitude_final"</span>,</span>
<span>                     <span class="st">"type_altitude"</span>,</span>
<span>                     <span class="st">"year_end"</span>,</span>
<span>                     <span class="st">"month_end"</span>,</span>
<span>                     <span class="st">"day_end"</span>,</span>
<span>                     <span class="st">"hour_end"</span>,</span>
<span>                     <span class="st">"minute_end"</span>,</span>
<span>                     <span class="st">"second_end"</span>,</span>
<span>                     <span class="st">"time_decimal"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">receptor</span><span class="op">$</span><span class="va">altitude_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">receptor</span><span class="op">$</span><span class="va">altitude_final</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">receptor</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_format.html">obs_format</a></span><span class="op">(</span><span class="va">receptor</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">receptor_agl</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">receptor_agl</span>,</span>
<span>         file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/receptor_tower_insitu_2020_AGL.txt"</span><span class="op">)</span>,</span>
<span>         sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">receptor_asl</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">receptor_asl</span>,</span>
<span>         file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/receptor_tower_insitu_2020_ASL.txt"</span><span class="op">)</span>,</span>
<span>         sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="application-for-other-sectors">Application for other sectors<a class="anchor" aria-label="anchor" href="#application-for-other-sectors"></a>
</h2>
<p>In this package we are sharing scripts to process other sectors The scripts are available in the path <code>https://github.com/ibarraespinosa/rtorf/tree/main/rscripts</code></p>
</div>
<div class="section level2">
<h2 id="implementation-in-python">Implementation in python:<a class="anchor" aria-label="anchor" href="#implementation-in-python"></a>
</h2>
<p>I’m currently implementing a version in python:</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="63%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">R</th>
<th align="left">description</th>
<th align="left">Python</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">fex</td>
<td align="left">File extension</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">invfile</td>
<td align="left">Methods for objects with class ‘invfile’</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_addltime</td>
<td align="left">local hour (bsed on longitude and time)</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_addstime</td>
<td align="left">Add solar time into obspack</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_addtime</td>
<td align="left">Add times into obspack</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_agg</td>
<td align="left">Aggregates ObsPack by time</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_find_receptors</td>
<td align="left">Compares expected receptors</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_footname</td>
<td align="left">Expected footprint name</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_format</td>
<td align="left">Formatting data</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_freq</td>
<td align="left">return numeric vector in intervals</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_index</td>
<td align="left">Summary of the ObsPack files (.txt)</td>
<td align="left">OK</td>
</tr>
<tr class="even">
<td align="left">obs_invfiles</td>
<td align="left">Generate files to perform inverse modeling</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_list.dt</td>
<td align="left">list.dt</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_meta</td>
<td align="left">Read obspack metadata</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_out</td>
<td align="left">outersect</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_plot</td>
<td align="left">Read obspack metadata</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_rbind</td>
<td align="left">rbind obspack</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_read</td>
<td align="left">Read obspack (.txt)</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_read_csvy</td>
<td align="left">reads CSVY</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_read_nc</td>
<td align="left">Read obspack (.nc)</td>
<td align="left">OK</td>
</tr>
<tr class="odd">
<td align="left">obs_roundtime</td>
<td align="left">round seconds from “POSIXct” “POSIXt” classes</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_summary</td>
<td align="left">Summary of the ObsPack files (.txt)</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_table</td>
<td align="left">Obspack Table</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">obs_trunc</td>
<td align="left">Trunc numbers with a desired number of decimals</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">obs_write_csvy</td>
<td align="left">Generates YAML and write data.frame</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">plot.invfile</td>
<td align="left">Methods for objects with class ‘invfile’</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">print.invfile</td>
<td align="left">Methods for objects with class ‘invfile’</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">sr</td>
<td align="left">Extacts n last characters</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">summary.invfile</td>
<td align="left">Methods for objects with class ’invfile</td>
<td align="left"></td>
</tr>
</tbody>
</table>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/noaa-gml/rtorf/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/noaa-gml/rtorf/issues/" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing rtorf</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Sergio Ibarra-Espinosa <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-3162-1905" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sergio Ibarra-Espinosa.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
