<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Summary • rtorf</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Summary"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">rtorf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ibarraespinosa/rtorf/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Summary</h1>
      <small class="dont-index">Source: <a href="https://github.com/ibarraespinosa/rtorf/blob/HEAD/paper.md" class="external-link"><code>paper.md</code></a></small>
    </div>


<div id="summary" class="section level1">

<p>Observations of greenhouse gas emissions are critical to monitor the state of the atmosphere, quantify present and historical emissions, and understand global climate change. Observation Package (ObsPack) is a specific format to deliver atmospheric measurements data of trace gasses [@masarie2014obspack]. The NOAA Global Monitoring Laboratory (GML) manages a global network of atmospheric observations compiled and delivered to the public as ObsPack CH4 GLOBALVIEW+. This product provides access to global methane observations made in surface, tower, aircrafts, aircores and ships. Processing global data can be cumbersome since they are provided as multiple text and NetCDF files. The text files consist of a commented metadata followed with the tabulated data which can have different headers across files. The metadata can have critical information which determines the nature of the file itself, such as altitude of the site, local hour, laboratory and more. Below the metadata, starts the section with tabulated data, with different header across files.</p>
</div>
<div class="section level1">
<h1 id="statement-of-need">Statement of need<a class="anchor" aria-label="anchor" href="#statement-of-need"></a></h1>
<p>In order to analyze greenhouse gasses measurements we developed the R package <code>rtorf</code>, which reads and processes NOAA/GML ObsPack GLOBALVIEW+ CH4 data. This package imports functions from <code>data.table</code> R package, which contains C bindings with parallel implementation via Open-MP [@dt]. <code>data.table</code> is faster than other Python, Julia and R implementations for data-science, providing a strong basis for <code>rtorf</code>. The main objective of <code>rtorf</code> is to integrate different CH4 ObsPack text files in a long format, adding fields for specific metadata information, with a tidy structure [@Silge2016]. Hence, the data can easily be processed with <code>data-table</code>, allowing to produce plots with <code>ggplot2</code> and other R packages [@g2].</p>
<p>The steps followed by <code>rtorf</code> are described in the following lines. First, it is necessary to create a summary of the data , read all the file names, identify key-words, sectors and full paths. The data is read iterating on each file for each category such as aircraft, tower, surface, flasks, ships and aircore. It is necessary to add UTC, local time and calculate altitude above ground level (agl) from the data. For continuous ground sites, afternoon observations are selected and averaged to reduce correlations and noise. Given the high frequency of observations of data, usually every second, aircraft data is usually averaged every 20 seconds. Once the data is processed for each category, it is merged in a long format. The installation and functions created to perform these tasks are shown in the following sections.</p>
</div>
<div class="section level1">
<h1 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a></h1>
<p>The <code>rtorf</code> functions are shown in the table 1.</p>
<p>Table 1. Functions and classes in <code>rtorf</code>.</p>
<table class="table"><colgroup><col width="31%"><col width="68%"></colgroup><thead><tr class="header"><th>Function</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td><code>invfile</code></td>
<td>Class with <code>print</code>, <code>summary</code> and <code>plot</code> methods</td>
</tr><tr class="even"><td><code><a href="reference/obs_addltime.html">obs_addltime()</a></code></td>
<td>Add local time based on metadata and longitude</td>
</tr><tr class="odd"><td><code><a href="reference/obs_addtime.html">obs_addtime()</a></code></td>
<td>Add UTC time</td>
</tr><tr class="even"><td><code><a href="reference/rtorf-deprecated.html">obs_addzero()</a></code></td>
<td>Format numbers to match specific requirements</td>
</tr><tr class="odd"><td><code><a href="reference/obs_agg.html">obs_agg()</a></code></td>
<td>Aggregates ObsPack by time</td>
</tr><tr class="even"><td><code><a href="reference/obs_find_receptors.html">obs_find_receptors()</a></code></td>
<td>Find expected receptors and NetCDF files</td>
</tr><tr class="odd"><td><code><a href="reference/obs_format.html">obs_format()</a></code></td>
<td>Format for some columns of data.table</td>
</tr><tr class="even"><td><code><a href="reference/obs_freq.html">obs_freq()</a></code></td>
<td>Return numeric vector in intervals</td>
</tr><tr class="odd"><td><code><a href="reference/obs_invfiles.html">obs_invfiles()</a></code></td>
<td>Construct <code>invfile</code> objects</td>
</tr><tr class="even"><td><code><a href="reference/obs_list.dt.html">obs_list.dt()</a></code></td>
<td>Rbind list of data.frames with different names</td>
</tr><tr class="odd"><td><code><a href="reference/obs_meta.html">obs_meta()</a></code></td>
<td>Reads ObsPack metadata</td>
</tr><tr class="even"><td><code><a href="reference/obs_out.html">obs_out()</a></code></td>
<td>Outersect, opposed as intersect</td>
</tr><tr class="odd"><td><code><a href="reference/obs_rbind.html">obs_rbind()</a></code></td>
<td>Rbind data.frames with different names</td>
</tr><tr class="even"><td><code><a href="reference/obs_read.html">obs_read()</a></code></td>
<td>Read files, and add metadata as columns</td>
</tr><tr class="odd"><td><code><a href="reference/obs_read_csvy.html">obs_read_csvy()</a></code></td>
<td>Read csvy file and prints yaml header</td>
</tr><tr class="even"><td><code><a href="reference/obs_roundtime.html">obs_roundtime()</a></code></td>
<td>Round seconds from “POSIXct” “POSIXt” classes</td>
</tr><tr class="odd"><td><code><a href="reference/obs_summary.html">obs_summary()</a></code></td>
<td>Construct summary of ObsPack as a data.frame</td>
</tr><tr class="even"><td><code><a href="reference/obs_table.html">obs_table()</a></code></td>
<td>Return a data.frame with summary of data</td>
</tr><tr class="odd"><td><code><a href="reference/obs_trunc.html">obs_trunc()</a></code></td>
<td>Trunc numbers with a desired number of decimals</td>
</tr><tr class="even"><td><code>obs_write()</code></td>
<td>Write CSVY to disk, YAML followed by tabulated</td>
</tr></tbody></table></div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a></h1>
<p>To install <code>rtorf</code>, the user must have installed the R package <code>remotes</code> and run the following script. This process will install all the required dependencies, such as <code>data.table</code>, <code>cptcity</code>, an R package with more than 7000 color palettes, and <code>lubridate</code>, a package to manage time and dates [@cpt;@lu]. Then, we call the libraries to load the function into the environment.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"ibarraespinosa/rtorf"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ibarraespinosa/rtorf" class="external-link">rtorf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></code></pre></div>
<p>For this manuscript, we are presenting the application of <code>rtorf</code> on tower observations.</p>
<div class="section level2">
<h2 id="obspack-summary">ObsPack summary<a class="anchor" aria-label="anchor" href="#obspack-summary"></a></h2>
<p>The first step consists in constructing a summary for the ObsPack. This is required to read the data, but also, identify <code>agl</code>, which is present in some of the file names. This function returns a <code>data.frame</code>. Optionally, the user can indicate a path to store the <code>data.frame</code>. <code>obs_summary</code> also prints a summary of the data. The second argument is the categories, and by default includes the categories shown below, to account for all the files. Then the summary <code>data.frame</code> contains the columns <code>id</code> as the full path to each file, <code>name</code> which is the name or relative path of the file, <code>n</code> just an id, <code>sector</code> such as tower, and the column <code>agl</code> which indicates the <code>agl</code> indicated in the name of the file if available. To read the documentation of this function, the user must run <code><a href="reference/obs_summary.html">?obs_summary</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">categories</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"aircraft-pfp"</span>,</span>
<span>  <span class="st">"aircraft-insitu"</span>,</span>
<span>  <span class="st">"surface-insitu"</span>,</span>
<span>  <span class="st">"aircore"</span>,</span>
<span>  <span class="st">"surface-pfp"</span>,</span>
<span>  <span class="st">"tower-insitu"</span>,</span>
<span>  <span class="st">"shipboard-insitu"</span>,</span>
<span>  <span class="st">"flask"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="st">"../../../obspack_ch4_1_GLOBALVIEWplus_v4.0_2021-10-14/data/txt"</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_summary.html">obs_summary</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Number of files of index: 362</span></span>
<span><span class="co">##              sector   N</span></span>
<span><span class="co">## 1:     aircraft-pfp  40</span></span>
<span><span class="co">## 2:  aircraft-insitu  11</span></span>
<span><span class="co">## 3:            flask 101</span></span>
<span><span class="co">## 4:   surface-insitu 124</span></span>
<span><span class="co">## 5:          aircore   1</span></span>
<span><span class="co">## 6:      surface-pfp  33</span></span>
<span><span class="co">## 7:     tower-insitu  51</span></span>
<span><span class="co">## 8: shipboard-insitu   1</span></span>
<span><span class="co">## 9:    Total sectors 362</span></span>
<span><span class="co">## Detected 136 files with agl</span></span>
<span><span class="co">## Detected 226 files without agl</span></span></code></pre>
<p>There are 362 files in the ObsPack directory. The printed information also shows the total at the bottom, as the sum of the individual file by sector. This is to ensure that the sum of files is equal to the total number of files found, shown at the top. furthermore, the printed information also shows that there are 136 files with the <code>agl</code> explicitly mentioned in the name of the file.</p>
<p>Sometimes we need more information about the site. For instance, what do the observations start and end. Then, we added the function <code>obs_table</code>, which calculates statistics summary of “time” and other numeric variables by file name, sector, site, altitude and mode. For instance, the observations in the site “SCT” in South Carolina, USA, were between “2015-08-19 21:30:00 UTC” and “2020-12-31 23:30:00 UTC”.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dft</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_table.html">obs_table</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span>,</span>
<span>                 categories <span class="op">=</span> <span class="st">"tower-insitu"</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">dft</span><span class="op">[</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">"SCT"</span>, <span class="op">]</span><span class="op">$</span><span class="va">timeUTC</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "2015-08-19 21:30:00 UTC" "2020-12-31 23:30:00 UTC"</span></span></code></pre>
<div class="section level3">
<h3 id="read-data">Read data<a class="anchor" aria-label="anchor" href="#read-data"></a></h3>
<p>Once the summary is built, the function <code>obs_read</code> will read the files available in the index file previously generated. Here we selected the category “tower-insitu”. The argument verbose prints which files are being read each time, by default. At the end, this function prints the total number of observations by type of altitude (agl or asl).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_read.html">obs_read</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span>,</span>
<span>               categories <span class="op">=</span> <span class="st">"tower-insitu"</span>,</span>
<span>               verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We added a function to plot the data read from ObsPack. The y-axis is the field <code>value</code> and the x-axis is by default <code>time</code>. The data illustrated sorted by color is the field <code>site_code</code>, with the default number of 3 sites. The argument <code>pal</code> is to define the color palette, used by the internally imported function <code><a href="https://rdrr.io/pkg/cptcity/man/cpt.html" class="external-link">cptcity::cpt</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/obs_plot.html">obs_plot</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">df</span>, time <span class="op">=</span> <span class="st">"time"</span>, yfactor <span class="op">=</span> <span class="fl">1e+09</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Found the following sites: </span></span>
<span><span class="co">##  [1] AZV   BRZ   BSD   CRV   DEM   DVV   GCI01 GCI02 GCI03 GCI04 HUN   IGR  </span></span>
<span><span class="co">## [13] KRS   LEF   MRC   NOY   RGL   SCT   SVV   TAC   VGN   WGC   WSD   YAK  </span></span>
<span><span class="co">## Plotting the following sites: </span></span>
<span><span class="co">## [1] AZV BRZ</span></span></code></pre>
<div class="float">
<embed src="paper_files/figure-latex/unnamed-chunk-6-1.pdf"></embed><div class="figcaption">First two sites in ObsPack</div>
</div>
<p>Here we can see 2.32 million observations for <code>tower-insitu</code>. These observations are made between 2004 and 2020. The identification of the altitude and type is critical. The approach used here consists of:</p>
<ol style="list-style-type: decimal"><li>Identify <code>agl</code> from the name of the tile.</li>
<li>If <code>agl</code> not present, search fill_values used in elevation and transform them into NA (not available)</li>
<li>If <code>agl</code> is not present, <code>agl = altitude - elevation</code>.</li>
<li>If there are some NA in elevation, will result some NA in <code>agl</code>
</li>
<li>A new column is added named <code>altitude_final</code> to store <code>agl</code> or <code>asl</code>
</li>
<li>Another column named <code>type_altitude</code> is added to identify <code>agl</code> or <code>asl</code>.</li>
<li>If there is any case NA in <code>altitude_final</code>, <code>type_altitude</code> is “not available”</li>
</ol></div>
<div class="section level3">
<h3 id="filtering">Filtering<a class="anchor" aria-label="anchor" href="#filtering"></a></h3>
<p>ObsPack includes global observations and sometimes we need to extract data for a specific region and periods of time. In this part we include spatial and temporal parameters to filter data. The year of interest is 2020, but we also included December of 2019 and January of 2021. At this stage, we can apply the spatial filter by using the coordinates.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">north</span> <span class="op">&lt;-</span> <span class="fl">80</span></span>
<span><span class="va">south</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">west</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">170</span></span>
<span><span class="va">east</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">50</span></span>
<span><span class="va">max_altitude</span> <span class="op">&lt;-</span> <span class="fl">8000</span></span>
<span><span class="va">evening</span> <span class="op">&lt;-</span> <span class="fl">14</span><span class="op">:</span><span class="fl">15</span></span>
<span></span>
<span><span class="va">yy</span> <span class="op">&lt;-</span> <span class="fl">2020</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">12</span><span class="op">]</span>,</span>
<span>            <span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span><span class="op">]</span>,</span>
<span>            <span class="va">df</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="va">yy</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">altitude_final</span> <span class="op">&lt;</span> <span class="va">max_altitude</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&lt;</span> <span class="va">north</span> <span class="op">&amp;</span></span>
<span>           <span class="va">latitude</span> <span class="op">&gt;</span> <span class="va">south</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&lt;</span> <span class="va">east</span> <span class="op">&amp;</span></span>
<span>           <span class="va">longitude</span> <span class="op">&gt;</span> <span class="va">west</span><span class="op">]</span></span></code></pre></div>
<p>After filtering by space and time, we have  million observations. Towers can have observations at different heights. Here we need to select one site with the observations registered at the highest height. The column with the height is named <code>altitude_final</code> and the max altitude was named <code>max_altitude</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfa</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">altitude_final</span><span class="op">)</span>,</span>
<span>          by <span class="op">=</span> <span class="va">site_code</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dfa</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"max_altitude"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="time">Time<a class="anchor" aria-label="anchor" href="#time"></a></h3>
<p>Here we need to start time columns. The function <code>obs_addtime</code> adds time columns <code>timeUTC</code>, <code>timeUTC_start</code> which shows the start time of each observation and <code>timeUTC_end</code> which shows the end time for each observation. Then we need to identify the local time with the function <code>add_ltime</code>. This is important because to identifying observations in the evening in local time. <code>add_ltime</code> uses two methods, first identify the time difference with utc by identifying the metadata column “site_utc2lst”. If this information is not available, with the aircrafts for instance, the local time is calculated with an approximation based on longitude:</p>
<p><span class="math display"><em>l</em><em>t</em> = <em>U</em><em>T</em><em>C</em> + <em>l</em><em>o</em><em>n</em><em>g</em><em>i</em><em>t</em><em>u</em><em>d</em><em>e</em>/15 * 60 * 60</span> Where <span class="math inline"><em>l</em><em>t</em></span> is the local time, <span class="math inline"><em>U</em><em>T</em><em>C</em></span> the time, <span class="math inline"><em>l</em><em>o</em><em>n</em><em>g</em><em>i</em><em>t</em><em>u</em><em>d</em><em>e</em></span> the coordinate. Then, the time is cut every two hours. Now, we identify the local time to select evening hours.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addtime.html">obs_addtime</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding timeUTC</span></span>
<span><span class="co">## Adding timeUTC_start</span></span>
<span><span class="co">## Adding timeUTC_end</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span><span class="op">$</span><span class="va">timeUTC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df2</span><span class="op">$</span><span class="va">timeUTC</span><span class="op">+</span><span class="fl">3600</span>,</span>
<span>                   breaks <span class="op">=</span> <span class="st">"2 hour"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span>tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="va">df3</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addltime.html">obs_addltime</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span></span>
<span><span class="va">df3</span> <span class="op">&lt;-</span> <span class="va">df3</span><span class="op">[</span><span class="va">lh</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">evening</span><span class="op">]</span></span></code></pre></div>
<p>Now there are 8391 observations. At this point we can calculate the averages of several columns by the cut time. The function <code>obs_agg</code> does this aggregation as shown in the following lines of code. The argument <code>gby</code> establish the function used to aggregate <code>cols</code>, in this case the function mean by time and altitude. Finally, we add local time again.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df4</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_agg.html">obs_agg</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">df3</span>,</span>
<span>               gby <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>               cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"value"</span>, <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"type_altitude"</span>,</span>
<span>                        <span class="st">"dif_time"</span>, <span class="st">"year_end"</span>, <span class="st">"site_utc2lst"</span><span class="op">)</span>,</span>
<span>               verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>               byalt <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Detecting dif_time. Adding ending times</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df5</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/obs_addltime.html">obs_addltime</a></span><span class="op">(</span><span class="va">df4</span><span class="op">)</span></span></code></pre></div>
<p>Now there are 4394 observations, 3997 less observations. Here we add the column <code>max_altitude</code> to identify the max altitude by site.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df5</span><span class="op">[</span>,</span>
<span>    <span class="va">max_altitude</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">altitude_final</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">site_code</span><span class="op">]</span></span>
<span><span class="va">df5</span><span class="op">[</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site_code"</span>,</span>
<span>      <span class="st">"altitude_final"</span>,</span>
<span>      <span class="st">"max_altitude"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     site_code altitude_final max_altitude</span></span>
<span><span class="co">##  1:       CRV           17.0           32</span></span>
<span><span class="co">##  2:       CRV           32.0           32</span></span>
<span><span class="co">##  3:       CRV            4.9           32</span></span>
<span><span class="co">##  4:       LEF          122.0          396</span></span>
<span><span class="co">##  5:       LEF           30.0          396</span></span>
<span><span class="co">##  6:       LEF          396.0          396</span></span>
<span><span class="co">##  7:       SCT          305.0          305</span></span>
<span><span class="co">##  8:       SCT           31.0          305</span></span>
<span><span class="co">##  9:       SCT           61.0          305</span></span>
<span><span class="co">## 10:       WGC           30.0          483</span></span>
<span><span class="co">## 11:       WGC          483.0          483</span></span>
<span><span class="co">## 12:       WGC           91.0          483</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="saving-master-as-text-and-csvy">Saving master as text and csvy<a class="anchor" aria-label="anchor" href="#saving-master-as-text-and-csvy"></a></h3>
<p>Now that we have all the required information, we can save the files. Here, we name the data.frame as master, because it contains all the information. This is important because some fields can be used in the future, and for traceability. For convenience, time variables are transformed into character before writing into the disk. The separation is space ” “.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">master</span> <span class="op">&lt;-</span> <span class="va">df5</span></span>
<span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC</span><span class="op">)</span></span>
<span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master</span><span class="op">$</span><span class="va">timeUTC_end</span><span class="op">)</span></span>
<span><span class="va">master</span><span class="op">$</span><span class="va">local_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">master</span><span class="op">$</span><span class="va">local_time</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html" class="external-link">fwrite</a></span><span class="op">(</span><span class="va">master</span>, </span>
<span>       file <span class="op">=</span> <span class="st">"tower_insitu_2020.txt"</span>,</span>
<span>       sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span></code></pre></div>
<p>The format Comma Separated Value with YAML (CSVY)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://csvy.org/" class="external-link uri"&gt;https://csvy.org/&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a> consists in a typical CSV with a YAML header. The function<code>obs_write</code> includes the argument <code>notes</code> which allows adding custom notes at the header of the file. Below the notes, <code>obs_write</code> adds the output of the R function <code>str</code>, which provides a vertical summary of the data, known as structure.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/obs_write_csvy.html">obs_write_csvy</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">master</span>,</span>
<span>              notes <span class="op">=</span> <span class="st">"tower 2020"</span>,</span>
<span>              out <span class="op">=</span> <span class="st">"tower_insitu_2020.csvy"</span><span class="op">)</span></span></code></pre></div>
<p>To check the YAML header we read the first 38 lines of the files that were generated. Here we can see the column names, type of data and first observations. The YAML header is delimited by the characters “—”.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"tower_insitu_2020.csvy"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">38</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="saving-receptors">Saving receptors<a class="anchor" aria-label="anchor" href="#saving-receptors"></a></h3>
<p>We need to filter some columns from the master files in a new object called receptors. This is needed because internally we run HYSPLIT [@hy] using the information from the receptors. In the case of a tower, we need to select observations with the highest altitude. The specific columns are selected as shown on the following code. We are selecting the ending times, because later HYSPLIT is run backwards based on the time of measurement, between ending and starting times. The columns about time are formatted to have two characters. For instance, the month 1, is formatted as “01”. We also need to filter for <code>type_altitude</code> equal 0, representing <code>agl</code>observations , or equal to 1, <code>asl</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>receptor <span class="ot">&lt;-</span> master[altitude_final <span class="sc">==</span> max_altitude,</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="st">"site_code"</span>,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>                     <span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>                     <span class="st">"hour"</span>, <span class="st">"minute"</span>, <span class="st">"second"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>                     <span class="st">"latitude"</span>, <span class="st">"longitude"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>                     <span class="st">"altitude_final"</span>, <span class="st">"type_altitude"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>                     <span class="st">"year_end"</span>, <span class="st">"month_end"</span>, <span class="st">"day_end"</span>, <span class="st">"hour_end"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>                     <span class="st">"minute_end"</span>, <span class="st">"second_end"</span>)]</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>receptor<span class="sc">$</span>altitude_final <span class="ot">&lt;-</span> <span class="fu">round</span>(receptor<span class="sc">$</span>altitude_final)</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>receptor <span class="ot">&lt;-</span> <span class="fu">obs_format</span>(receptor)</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(receptor_agl) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="fu">fwrite</span>(<span class="at">x =</span> receptor_agl,</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>         <span class="at">file =</span> <span class="st">"paper/receptor_tower_insitu_2020_AGL.txt"</span>),</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>  sep <span class="ot">=</span> <span class="st">" "</span><span class="er">)</span>}</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(receptor_asl) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>  <span class="fu">fwrite</span>(<span class="at">x =</span> receptor_asl,</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>         <span class="at">file =</span> <span class="st">"paper/receptor_tower_insitu_2020_ASL.txt"</span>),</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>  sep <span class="ot">=</span> <span class="st">" "</span><span class="er">)</span>}</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="recommendation-for-other-applications">Recommendation for other applications<a class="anchor" aria-label="anchor" href="#recommendation-for-other-applications"></a></h2>
<p>The approach to generate receptors depends on each type of observation and other considerations. For instance, aircraft with continuous observations at each second can be filtered and averaged every 20 seconds. In that way, the footprints are still representative and it would not be necessary to run HYSPLIT every second. Of course, it depends on the application and objective of the study. For this manuscript, we are presenting the generation of receptors based on tower observations. Furthermore, in this package we are sharing scripts to process other sectors The scripts are available in the path <code>https://github.com/ibarraespinosa/rtorf/tree/main/rscripts</code></p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a></h2>
<p>In this manuscript we presented an <code>robskpack</code>, an R package to read and process <span class="math inline"><em>C</em><em>H</em><sub>4</sub></span> ObsPack GLOBALVIEW+ published by the Global Monitoring Laboratory (GML) from the National Oceanographic and Atmospheric Administration (NOAA). <code>rtorf</code> reads the text data which have different headers and organizes them in a common format. Then, this software applies calculations to filter observations by time and space. Finally, this software generates receptors in a suitable format that allows it to run HYSPLIT and generate footprints. This software does not provide methods to run HYSPLIT, but the user can follow the site <a href="https://www.ready.noaa.gov/HYSPLIT.php" class="external-link uri">https://www.ready.noaa.gov/HYSPLIT.php</a>.</p>
</div>
</div>
<div class="section level1">
<h1 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a></h1>
<p>Funding: This project is funded by the NOAA Climate Program Office AC4 and COM programs (NA21OAR4310233 / NA21OAR4310234). This research was supported by the NOAA cooperative agreement NA22OAR4320151.</p>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h1>
</div>



  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Sergio Ibarra-Espinosa.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

